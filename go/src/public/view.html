<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <title>CodeFight-代码の战争</title>
  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  <style type="text/css">
   * {
    margin: 0;
    padding: 0;
  }

  html, body,#app {
    height: 100%;
    width: 100%;
  }
  </style>
</head>

<body>
  <div id="app">
    <canvas id="viewMap"></canvas>
  </div>

<script>
let rtk = {{.}}

var app = new Vue({
  el: '#app',
  data: {
    canvas: {},
    context: {},
    COLOR: 'lightblue',
    GRID_SIZE: 50,
    WH:'',
    WW:'',
  },
  created() {
    this.WW = document.documentElement.clientWidth || document.body.clientWidth;
    this.WH = document.documentElement.clientHeight || document.body.clientHeight;
  },
  mounted() {
    this.canvas = document.querySelector('#viewMap')
    this.context = this.canvas.getContext('2d')
    this.init()
  },
  methods: {
    //初始化
    init() {

      let loc = window.location

      let uri = 'ws:'

      if (loc.protocol === 'https:') {
        uri = 'wss:'
      }
      uri += '//' + loc.host
      uri += '/ws'

      this.ws = new WebSocket(uri)

      this.ws.onopen = ()=> {
        console.log('Connected')
        this.ws.send(rtk)
      }

      let flag = true
      this.ws.onmessage = evt=> {
        console.log('onmessage', evt.data)
        let recvData = JSON.parse(evt.data)
        console.log(recvData)
        if (flag) {
          flag = false
          let row = recvData['value']['row'], col = recvData['value']['col']
          this.resizeCanvas(row, col)
          this.drawBoard(row, col)
        }
      }

      this.ws.onerror = ()=> {
        console.log('WebSocket has error')
      }
    },
    // 调整地图大小
    resizeCanvas: function (row, col) {
      this.canvas.width = this.GRID_SIZE * row
      this.canvas.height = this.GRID_SIZE * col
    },
    //画地图
    drawBoard: function (row, col) {
      for (let i = 0; i < row; i++) {
        for (let j = 0; j < col; j++) {
          this.context.beginPath()
          //边框颜色
          this.context.strokeStyle = '#000'
          this.context.fillStyle = this.COLOR
          this.context.fillRect(i * this.GRID_SIZE, j * this.GRID_SIZE, this.GRID_SIZE, this.GRID_SIZE)
          this.context.strokeRect(i * this.GRID_SIZE, j * this.GRID_SIZE, this.GRID_SIZE, this.GRID_SIZE)
          this.context.closePath()
        }
      }
    }
  }
})
</script>
</body>

</html>